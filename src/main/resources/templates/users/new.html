<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Signup</title>
	<style>
		.hidden {
			display: none;
		}
	</style>
	<script>
		function showImageField(){
			var imageView = document.getElementById('thumbnail-image');
			var uploadWidget = document.getElementById('upload_widget');
			var imagePreview = document.getElementById('image-preview');
			imageView.classList.remove('hidden');
			uploadWidget.classList.remove('hidden');
			imagePreview.classList.remove('hidden');
		}
	</script>
</head>
<body>
<script>
	document.addEventListener("DOMContentLoaded", function() {
		const urlParams = new URLSearchParams(window.location.search);
		if (urlParams.has('error')) {
			const error = urlParams.get('error');
			switch (error) {
				case 'username':
					alert("Username already exists.");
					break;
				case 'emailExists':
					alert("Email already exists.");
					break;
				case 'email':
					alert("Invalid email address.");
					break;
				case 'password':
					alert("Passwords do not match or are invalid.");
					break;
				default:
					alert("Unknown error occurred.");
					break;
			}
		}
	});
</script>

<header>
	<div sec:authorize="isAuthenticated()">
		<a href="/logout">Logout</a>
	</div>
	<div sec:authorize="isAnonymous()">
		<a href="/login">Login</a>
	</div>
</header>
<form action="#" th:action="@{/users}" th:object="${user}" method="post">
    <p>Username: <input type="text" th:field="*{username}" /></p>
	<p>First Name: <input type="text" th:field="*{firstname}" /></p>
	<p>Last Name: <input type="text" th:field="*{lastname}" /></p>
	<p>Email: <input type="text" th:field="*{email}" /></p>
	<p>Bio: <input type="text" th:field="*{bio}" /></p>
    <p>Password: <input type="password" th:field="*{password}" /></p>
	<p>Confirm Password: <input type="password" id="confirm_password" name="confirm_password" /></p>
	<input type="hidden" id="profilePic" name="profilePic" th:field="*{profilePicture}"/>
	<p class="hidden" id="image-preview">
		<img th:src="thumbnail_image" id="thumbnail-image"/>
	</p>
	<button type="button" id="upload_widget" th:onclick="'showImageField()'">Upload Media</button>
	<p><input type="submit" value="Submit" id="submit"/> <input type="reset" value="Reset" /></p>
</form>
<script src="https://upload-widget.cloudinary.com/latest/global/all.js" type="text/javascript"></script>

<script type="text/javascript">

	var myWidget = cloudinary.createUploadWidget({
				cloudName: 'dk3vxa56n',
				uploadPreset: 'test_preset'}, (error, result) => {
				if (!error && result && result.event === "success") {
					console.log('Done! Here is the image info: ', result.info);
					document.getElementById("profilePic").value = result.info.thumbnail_url;
					document.getElementById("thumbnail-image").src = result.info.thumbnail_url;

				}
			}
	)

	document.getElementById("upload_widget").addEventListener("click", function(){
		myWidget.open();
	}, false);

</script>
</body>
</html>